<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ecosystem Embed</title>
    <script type="importmap">{
      "imports": {
        "three": "https://unpkg.com/three@0.151.3/build/three.module.js",
        "three/examples/jsm/controls/OrbitControls.js": "https://unpkg.com/three@0.151.3/examples/jsm/controls/OrbitControls.js"
      }
    }</script>
    <style>
      @font-face {
        font-family: 'Cocogoose';
        src: url('/fonts/Cocogoose-Pro-Regular-trial.ttf') format('truetype');
        font-weight: 400;
        font-display: swap;
      }
      @font-face {
        font-family: 'Cocogoose';
        src: url('/fonts/Cocogoose-Pro-Light-trial.ttf') format('truetype');
        font-weight: 300;
        font-display: swap;
      }
      html, body { margin: 0; height: 100%; background: #f5f5f5; overflow: hidden; font-family: 'Cocogoose', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; }
      html.dark, html.dark body { background: #0a0a0a; }
      @media (prefers-color-scheme: dark) {
        html:not(.light), html:not(.light) body { background: #0a0a0a; }
      }
      #root { width: 100%; height: 100%; position: relative; }
      #fallback { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; color: #555; font-family: 'Cocogoose', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; font-size: 12px; text-align: center; padding: 8px; }
      html.dark #fallback { color: #aaa; }
      .ecosystem-visualization { width: 100% !important; height: 100% !important; position: relative !important; }
      #three-container { width: 100% !important; height: 100% !important; position: relative !important; }
      #control-panel { display: none !important; }
      .node-label { font-size: 8px !important; padding: 2px 4px !important; background-color: rgba(255,255,255,0.9) !important; font-weight: 400 !important; font-family: 'Cocogoose', system-ui, sans-serif !important; }
      html.dark .node-label { background-color: rgba(30,30,30,0.95) !important; color: rgba(255,255,255,0.9) !important; }
      @media (prefers-color-scheme: dark) {
        html:not(.light) .node-label { background-color: rgba(30,30,30,0.95) !important; color: rgba(255,255,255,0.9) !important; }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <div id="fallback">Failed to load ecosystem preview</div>

    <script>
      // Detect dark mode from URL parameter, localStorage, or parent
      (function() {
        const params = new URLSearchParams(location.search);
        const darkParam = params.get('dark');
        const storedDarkMode = localStorage.getItem('dark-mode');
        
        // Check URL parameter first, then localStorage, then default to dark (since homepage forces dark)
        const isDark = darkParam === 'true' || (darkParam === null && (storedDarkMode === 'true' || storedDarkMode === null));
        
        if (isDark) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.add('light');
        }
      })();
      
      window.__RUN_ECOSYSTEM_AUTO__ = false;
      console.log('[EcosystemTooltip] Embed HTML loaded');
      window.addEventListener('error', (e) => {
        console.error('[EcosystemTooltip][Embed Error]', e.message, e.error);
      });
      window.addEventListener('unhandledrejection', (e) => {
        console.error('[EcosystemTooltip][Embed Promise Rejection]', e.reason);
      });
    </script>

    <script type="module">
      (async () => {
        try {
          const params = new URLSearchParams(location.search);
          const scale = parseFloat(params.get('scale') || '1.1');
          window.__ECOSYSTEM_SCALE_FACTOR__ = isFinite(scale) && scale > 0 ? scale : 1.1;

          const mod = await import('/ecosystem.js');
          console.log('[EcosystemTooltip] ecosystem.js imported. exports:', Object.keys(mod));
          if (mod && typeof mod.runEcosystem === 'function') {
            console.log('[EcosystemTooltip] Calling runEcosystem with scale', window.__ECOSYSTEM_SCALE_FACTOR__);
            try {
              mod.runEcosystem(document.getElementById('root'));
              console.log('[EcosystemTooltip] runEcosystem executed');
            } catch (innerErr) {
              console.error('[EcosystemTooltip] Error in runEcosystem:', innerErr);
              document.getElementById('fallback').style.display = 'flex';
            }
          } else {
            console.error('[EcosystemTooltip] runEcosystem export not found');
            document.getElementById('fallback').style.display = 'flex';
          }
        } catch (err) {
          console.error('[EcosystemTooltip] Failed to import /ecosystem.js:', err);
          document.getElementById('fallback').style.display = 'flex';
        }
      })();
    </script>
  </body>
  </html>


